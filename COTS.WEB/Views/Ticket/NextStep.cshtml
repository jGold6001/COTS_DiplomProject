@model IEnumerable<COTS.WEB.Models.TicketViewModel>

@{
    ViewBag.Title = "NextStep";
}

<h2>NextStep</h2>
<main class="container">
    <div class="row">
        <div id="timer"></div>
    </div>
    <div id="tickets" class="row" style="border-bottom: 1px solid grey">
        <h5><b>Выбранные места</b></h5>
        <p><b>Фильм:</b> @Model.FirstOrDefault().Movie</p>
        <p><b>Кинотеатр:</b> @Model.FirstOrDefault().Cinema</p>
        @foreach (var item in Model)
        {
            <div class="row">
                <div class="col-lg-6">Ряд: @item.Row, Место: @item.Place</div>              
                <div class="col-lg-6" style="text-align:right">Цена: @item.Price</div>
            </div>
        }      
    </div>
    <div class="row" style="margin-top: 10px;">  
        <div class="col-lg-6">
            <div class="col-lg-6 container">
                <input type="button" id="order" value="Оформить покупку" />
            </div>
            <div class="col-lg-6 container">
                <input type="button" id="cancel" value="Отмена" />
            </div>
        </div>   
    </div>
</main>

<script src="~/Scripts/jquery-3.1.1.min.js"></script>
<script type="text/javascript">
    $(function () {

        function bookingTime() {
            var dateNow = new Date(),
            date = new Date(dateNow);
            date.setMinutes(dateNow.getMinutes() + 7);

            var countDown = date;


            var x = setInterval(function () {
                var now = new Date().getTime();
                var distance = countDown - now;

                var minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                var seconds = Math.floor((distance % (1000 * 60)) / 1000);

                document.getElementById("timer").innerHTML =  minutes + " : " + seconds;

                if (distance < 0) {
                    clearInterval(x);
                    $.post('@Url.Action("RemovePurchase", "Ticket")', { purchaseId: '@ViewData["PurchaseID"]' });
                    document.location.href = '@Url.Action("Index", "Movie")';
                }
            }, 1000);
        };


        bookingTime();

        $('#order').on('click', function () {
            var url = '@Url.Action("Ordering", "Ticket", new { purchaseId = ViewData["PurchaseID"] })';
            window.location.href = url;
        });


        $('#cancel').on('click', function () {
             $.post('@Url.Action("RemovePurchase", "Ticket")', { purchaseId: '@ViewData["PurchaseID"]' });

             setTimeout(function () {
                 document.location.href = '@Url.Action("Index", "Movie")';
             }, 1000);


        });

    });
</script>